<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="pdltools_extra.css" rel="stylesheet" type="text/css"/>
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-47128600-1', 'auto');
    ga('send', 'pageview');
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="pdl.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">PDL Tools
   &#160;<span id="projectnumber">1.8</span>
   </div>
   <div id="projectbrief">User Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="gettingstarted.html"><span>Getting&#160;Started</span></a></li>
      <li><a href="installpage.html"><span>Installation</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="changelog.html"><span>Change&#160;Log</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Groups</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">strat_partition<div class="ingroups"><a class="el" href="group__grp__sampling.html">Sampling</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><b>Contents</b> </p><ul>
<li class="level1">
<a href="#strat_partition_syntax">Syntax</a> </li>
<li class="level1">
<a href="#strat_partition_usage">Usage</a> </li>
<li class="level1">
<a href="#strat_partition_example">Example</a> </li>
</ul>
</div><dl class="section user"><dt>About</dt><dd>A table is given with one or more ID columns and a grouping column. Also given are a set of proportions, summing to 1.0 or less. The function creates a new table with the ID and grouping columns, and also with a new <code>out_label</code> column of user-defined name, such that each group is partitioned randomly by the labels according to the desired proportions.</dd></dl>
<p><a class="anchor" id="strat_partition_syntax"></a></p><dl class="section user"><dt>Syntax</dt><dd><pre class="syntax">
FUNCTION strat_partition(in_tab VARCHAR, out_tab VARCHAR,
                         out_cols VARCHAR, grouping_col VARCHAR,
                         out_label VARCHAR, proportions float8[])
RETURNS VOID;
</pre></dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">in_tab</td><td>Name of input table. </td></tr>
    <tr><td class="paramname">out_tab</td><td>Name of output table. </td></tr>
    <tr><td class="paramname">out_cols</td><td>Columns to reproduce in the output table. These should be given as a comma-separated string. Should not include the grouping column, <code>grouping_col</code>. </td></tr>
    <tr><td class="paramname">grouping_col</td><td>Column to stratify by. Choose NULL for non-stratified. </td></tr>
    <tr><td class="paramname">out_label</td><td>Name of column to add to the output table, to specify the output partition. </td></tr>
    <tr><td class="paramname">proportions</td><td>Array denoting the partitioning proportions.</td></tr>
  </table>
  </dd>
</dl>
<p><a class="anchor" id="strat_partition_usage"></a></p><dl class="section user"><dt>Usage</dt><dd>The function creates a new table, <code>out_tab</code>, containing all columns from <code>out_cols</code> and the column <code>grouping_col</code>, both copied from the input table <code>in_tab</code>. To these, a new column <code>out_label</code> is added, which randomly splits each group specified by <code>grouping_col</code> into parts of the proportions specified by the <code>proportions</code> array.</dd></dl>
<p>If the <code>proportions</code> array is \([p_0,p_1,\ldots, p_{k-1}]\), where <em>k</em> is the array's length, the <code>out_label</code> value is an integer between 0 and <em>k</em>, so that in each group, if the size of the group is <em>n</em>, the number of elements to be labeled <em>i</em> or less, for every <em>i</em> in the range \([0,k)\), is exactly \(\lceil (p_0+\cdots+p_i) n \rceil\). All the remaining elements are labeled <em>k</em>. This is proportional partitioning that ensures the following:</p><ul>
<li>The number of elements labeled exactly <em>i</em> in each group of size <em>n</em> is always either \(\lceil p_i n \rceil\) or \(\lfloor p_i n \rfloor\), and always exactly \( p_i n \) if \( p_i n \) is an integer.</li>
<li>If two groups have the same total number of elements, they also have the same number of elements receiving each label.</li>
<li>Partitioning again with the same proportions over the same data will result in the same number of elements receiving each label in each group, though the choice of which elements go to which part will change.</li>
<li>If \(p_0\) is positive, each group will have at least one element labeled 0.</li>
</ul>
<p><a class="anchor" id="strat_partition_example"></a></p><dl class="section user"><dt>Examples</dt><dd><pre class="fragment">user=# CREATE TABLE base_table AS SELECT x val1, 2*x val2, (x*x)%3 stratum
         FROM generate_series(1,20) x
       DISTRIBUTED BY (val1);
SELECT 20

user=# SELECT * FROM base_table;
 val1 | val2 | stratum 
------+------+---------
    1 |    2 |       1 
    3 |    6 |       0 
    5 |   10 |       1 
    7 |   14 |       1 
    9 |   18 |       0 
   11 |   22 |       1 
   13 |   26 |       1 
   15 |   30 |       0 
   17 |   34 |       1 
   19 |   38 |       1 
    2 |    4 |       1 
    4 |    8 |       1 
    6 |   12 |       0 
    8 |   16 |       1 
   10 |   20 |       1 
   12 |   24 |       0 
   14 |   28 |       1 
   16 |   32 |       1 
   18 |   36 |       0 
   20 |   40 |       1 
(20 rows)

user=# SELECT strat_partition('base_table','labeled_table',
                'val1,val2', 'stratum','label',ARRAY[0.1,0.4,0.01]);
 strat_partition
-----------------

(1 row)

user=# SELECT * FROM labeled_table;
 val1 | val2 | stratum | label
------+------+---------+-------
    1 |    2 |       1 |     1
    3 |    6 |       0 |     1
    5 |   10 |       1 |     3
    7 |   14 |       1 |     3
    9 |   18 |       0 |     2
   11 |   22 |       1 |     3
   13 |   26 |       1 |     3
   15 |   30 |       0 |     0
   17 |   34 |       1 |     0
   19 |   38 |       1 |     1
    2 |    4 |       1 |     3
    4 |    8 |       1 |     3
    6 |   12 |       0 |     1
    8 |   16 |       1 |     0
   10 |   20 |       1 |     2
   12 |   24 |       0 |     3
   14 |   28 |       1 |     1
   16 |   32 |       1 |     1
   18 |   36 |       0 |     3
   20 |   40 |       1 |     1
(20 rows)
</pre></dd></dl>
<p>In this example, <code>strat_partition</code> successfully divided group 0 to labels of sizes [1,2,1,2] and group 1 to labels of sizes [2,5,1,6], as per the desired [10%,40%,1%,49%] cut. The parts of size 10% and 1% were rounded up to create a whole-number partition, while the parts of size 40% and 49% were rounded down.</p>
<dl class="section user"><dt>Prerequisites</dt><dd>PL/Perl </dd></dl>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.nl/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
