<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="pdltools_extra.css" rel="stylesheet" type="text/css"/>
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-47128600-1', 'auto');
    ga('send', 'pageview');
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="pdl.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">PDL Tools
   &#160;<span id="projectnumber">1.8</span>
   </div>
   <div id="projectbrief">User Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="gettingstarted.html"><span>Getting&#160;Started</span></a></li>
      <li><a href="installpage.html"><span>Installation</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="changelog.html"><span>Change&#160;Log</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Groups</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">"@" (Pseudo-operator)<div class="ingroups"><a class="el" href="group__grp__sugar__funcs.html">SUgAR Pseudofunctions</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><b>Contents</b> </p><ul>
<li class="level1">
<a href="#opat_syntax">Syntax</a> </li>
<li class="level1">
<a href="#opat_usage">Usage</a> </li>
<li class="level1">
<a href="#opat_example">Example</a> </li>
</ul>
</div><dl class="section user"><dt>About</dt><dd>A SUgAR pseudoaggregate, passing the values in a chosen column and window as an array.</dd></dl>
<p><a class="anchor" id="opat_syntax"></a></p><dl class="section user"><dt>Syntax</dt><dd><pre class="syntax">
@(x,w)
</pre> Aggregates the values of column <em>x</em> inside window <em>w</em> and returns these as an array. <em>"x"</em> may be an expression. <pre class="syntax">
@(x)
@x
</pre> When <em>"w"</em> is not specified, its value defaults to <code>DEFAULT_WINDOW</code>, which should be defined in the same SUgAR query. If it is not defined, the aggregation is performed over the entire column.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">x</td><td>Value column to be aggregated. </td></tr>
    <tr><td class="paramname">w</td><td>Window to perform aggregation on.</td></tr>
  </table>
  </dd>
</dl>
<p><a class="anchor" id="opat_usage"></a></p><dl class="section user"><dt>Usage</dt><dd>The purpose of this pseudoaggregate is to allow a user to conveniently pass columnar values into procedural languages, by aggregating them into arrays and sending them to the procedural language function call in a single invocation. In the procedural language function requires more than one parameter, the pseudoaggregate can be called separately for each parameter.</dd></dl>
<p>The pseudoaggregate returns an array of column values. The order within the array is not guaranteed. However, several calls to this pseudoaggregate made in the same query and using the same choice of <em>"w"</em> are guaranteed to all return arrays in the same row-wise order. This feature, currently guaranteed by undocumented GPDB features, is what allows the pseudoaggregate to be used conveniently to prepare several parameters for sending to a single invocation of a procedural language call.</p>
<p>Note that PL functions may not accept arrays with <code>NULL</code> values in them gracefully, so it is important to weed out the rows containing <code>NULL</code> values prior to aggregation. The '@' operator will raise an exception if applied on a column of inputs that includes NULLs.</p>
<p>The operator precedence of '@' is fairly low, ensuring that '@ x+3' means the same thing as '@(x+3)', which is probably the correct interpretation. To override this behavior, simply use parentheses: '@(x)+3'.</p>
<dl class="section warning"><dt>Warning</dt><dd>The '@' SUgAR operator conflicts with the standard PostgreSQL '@' operator whose meaning is absolute-value taking. When using SUgAR, opt for <code><a class="el" href="complex__type_8sql__in.html#a649879fd77f405417288b05c458c791f">abs()</a></code>, instead.</dd></dl>
<p><a class="anchor" id="opat_example"></a></p><dl class="section user"><dt>Examples</dt><dd><pre class="fragment">user=# CREATE TABLE test_data
user-# (fyear integer,firm float8,eps float8);
CREATE TABLE
user=# 
user=# INSERT INTO test_data
user-#   SELECT (b.f + 1) % 10 + 2000 AS fyear,
user-#          floor((b.f+1)/10) + 50 AS firm,
user-#          f::float8/100 + random()/10 AS eps
user-#          FROM generate_series(-500,499,1) b(f);
INSERT 0 1000
user=#
user=# -- We define a new procedural language function, to calculate
user=# -- the slope of a linear model regression line. Most conveniently,
user=# -- this function accepts its parameters in the form of two arrays.
user=# CREATE OR REPLACE FUNCTION r_regr_slope(x float8[], y float8[])
user-# RETURNS float8 AS $BODY$
user$#   slope &lt;- NA
user$#   if (length(x)==9) try (slope &lt;- lm(y ~ x)$coefficients[2])
user$#     return(slope)
user$# $BODY$ LANGUAGE plr;
CREATE FUNCTION
user=# 
user=# -- By invoking the '@' pseudoaggregate, we can now instantly make
user=# -- the newly-defined UDF "r_regr_slope" into either a window function
user=# -- or an aggregate function.
user=# SELECT sugar($SUGAR$
user$#   CREATE TABLE outtable AS
user$#     SELECT *, r_regr_slope(@eps, @lag_eps) AS slope_R FROM (
user$#       SELECT firm, fyear, eps,
user$#         lag(eps) OVER (PARTITION BY firm ORDER BY firm, fyear) AS lag_eps
user$#       FROM test_data) AS a
user$#     WHERE eps IS NOT NULL AND lag_eps IS NOT NULL
user$#     WINDOW default_window AS (
user$#       PARTITION BY firm ORDER BY firm, fyear ROWS 8 PRECEDING
user$#     )
user$#   DISTRIBUTED BY (fyear);
user$# $SUGAR$);
 sugar
-------

(1 row)
</pre></dd></dl>
<p>The query creates a table, <code>"outtable"</code>, containing for each firm and each year (<code>"fyear"</code>), in addition to its earnings per share (<code>"eps"</code>) and its previous year's earnings per share (<code>"lag_eps"</code>), also the slope coefficient relating the firm's earnings per share with its previous year's earnings per share, as estimated over the current and 8 preceding years.</p>
<dl class="section note"><dt>Note</dt><dd><ol type="1">
<li>The exclusion <code>"WHERE eps IS NOT NULL and lag_eps IS NOT NULL"</code> avoids the creation of <code>NULL</code> values in arrays. The function <code>"r_regr_slope"</code> would have balked at such inputs.</li>
<li>The definition <code>"WINDOW default_window AS"</code> defines the window that @eps and @lag_eps work on. <code>"DEFAULT_WINDOW"</code>, regardless of case, should be taken as a reserved word when using the '@' pseudoaggregate. Had it not been defined anywhere within the SUgAR query, the aggregation would have been done over the entire column.</li>
<li>Note that '@eps' and '@lag_eps' are guaranteed to have the same aggregation order, or else the <code>"r_regr_slope"</code> calculation would not have yielded the correct result.</li>
<li>This example involves nested querying, running the function with an argument created on the fly (with a native window function), data partitioning, ordering, a rolling window, etc.. This is to demonstrate the fact that '@' continues to work well even in complex situations.</li>
<li>The example above was adopted from a blog entry by Joe Conway.</li>
</ol>
</dd></dl>
<p>(Written by <a href="#" onclick="location.href='mai'+'lto:'+'mbr'+'an'+'d@p'+'iv'+'ota'+'l.'+'io'; return false;">Michael Brand</a>, 3 Mar 2013.) </p>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.nl/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
