<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="pdltools_extra.css" rel="stylesheet" type="text/css"/>
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-47128600-1', 'auto');
    ga('send', 'pageview');
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="pdl.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">PDL Tools
   &#160;<span id="projectnumber">1.8</span>
   </div>
   <div id="projectbrief">User Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="gettingstarted.html"><span>Getting&#160;Started</span></a></li>
      <li><a href="installpage.html"><span>Installation</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="changelog.html"><span>Change&#160;Log</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Groups</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">pivot (Pseudo-aggregate)<div class="ingroups"><a class="el" href="group__grp__sugar__funcs.html">SUgAR Pseudofunctions</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><b>Contents</b> </p><ul>
<li class="level1">
<a href="#pivot_syntax">Syntax</a> </li>
<li class="level1">
<a href="#pivot_usage">Usage</a> </li>
<li class="level1">
<a href="#pivot_example">Example</a> </li>
</ul>
</div><dl class="section user"><dt>About</dt><dd>Given a pivot column, <em>'colx'</em> and a value column, <em>'colv'</em>, this SUgAR pseudo-aggregate-function, when used in a query grouped by a grouping column <em>'coly'</em>, produces a set of columns, one for each value of <em>'colx'</em>, and places <em>'colv'</em> values in the column determined by the <em>'colx'</em> value and the row determined by the <em>'coly'</em> value in conjunction with which they appeared in the original table data. If more than one value of <em>'colv'</em> fits a particular row/column combination, the set of <em>'colv'</em> values are aggregated together.</dd></dl>
<p><a class="anchor" id="pivot_syntax"></a></p><dl class="section user"><dt>Syntax</dt><dd><pre class="syntax">
pivot(colx,t,colv)
</pre> Cross-tabulate <em>colv</em> according to the values of <em>colx</em>.</dd></dl>
<pre class="syntax">
pivot(colx,t,colv,agg)
</pre><p> Same as <code>pivot(<em>colx</em>,<em>t</em>,<em>colv</em>)</code>, but overrides the default aggregation function, which is <code>"unique_element"</code>.</p>
<pre class="syntax">
pivot(colx,t,colv,agg,default)
</pre><p> Same as <code>pivot(<em>colx</em>,<em>t</em>,<em>colv</em>,<em>agg</em>)</code>, but uses <em>"default"</em> instead of <code>"NULL"</code> for missing values.</p>
<pre class="syntax">
pivot(colx,t,colv,agg,default,fcolx)
</pre><p> Same as <code>pivot(<em>colx</em>,<em>t</em>,<em>colv</em>,<em>agg</em>,<em>default</em>)</code>, but uses <em>t.fcolx</em> to discover pivot columns, rather than <em>t.colx</em>. Using <code>NULL</code> for <em>fcolx</em> has the same effect as choosing it to equal <em>colx</em>.</p>
<pre class="syntax">
pivot(colx,t,colv,agg,default,fcolx,formatspec)
</pre><p> Same as <code>pivot(<em>colx</em>,<em>t</em>,<em>colv</em>,<em>agg</em>,<em>default</em>,<em>fcolx</em>)</code>, but names the columns in a user-defined way.</p>
<pre class="syntax">
pivot(colx,t,colv,agg,default,fcolx,formatspec,colchoice)
</pre><p> Same as <code>pivot(<em>colx</em>,<em>t</em>,<em>colv</em>,<em>agg</em>,<em>default</em>,<em>fcolx</em>,<em>formatspec</em>)</code>, but allows the caller explicit control on which columns are created in pivoting.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">colx</td><td>The pivot column. Its values determine where <em>colv</em> values will appear. </td></tr>
    <tr><td class="paramname">t</td><td>A table. Pivot columns are created according to the values in <em>t.colx</em>. </td></tr>
    <tr><td class="paramname">colv</td><td>The value column. Its values are the ones presented (and aggregated) in the new pivot table. </td></tr>
    <tr><td class="paramname">agg</td><td>The aggregation function to be applied if multiple <em>colv</em> values need to be aggregated into the same table cell. SUgAR supplies two aggregation functions out-of-the-box for this purpose: <code>'unique_element'</code> and <code>'choose_any'</code>. The default is <code>'unique_element'</code>. It places <em>colv</em> values into pivot-table cells as long as the assignment is unique. If two <em>colv</em> values compete for the same row and column, an exception is thrown. The aggregate <code>'choose_any'</code> works the same way, but suppresses the exception. If several <em>colv</em> values compete for the same row and column, one is chosen arbitrarily and placed in the cell. The aggregate guarantees that a cell will be non-NULL if there are any non-NULL values to be assigned to it. The parameter <em>'agg'</em> can be any aggregate, including these two, any standard aggregate and any user-defined aggregate. </td></tr>
    <tr><td class="paramname">default</td><td>The value given to a cell for which no <em>colv</em> values are assigned. By default this is NULL. Typically, the choice of <em>agg</em> function leads to a corresponding choice of <em>'default'</em>. For example, the <em>agg</em> function <code>'sum'</code> is likely to appear with a default '0'. This value indicates the appropriate return value for the aggregation of zero elements. </td></tr>
    <tr><td class="paramname">fcolx</td><td>If present (and not <code>NULL</code>), the values of <em>t.fcolx</em> are used generate the list of pivot columns, rather than <em>t.colx</em>. </td></tr>
    <tr><td class="paramname">formatspec</td><td>Specification of the method by which to generate names for the pivot-table column. By default, or if given a <code>NULL</code>, the value of <em>formatspec</em> is taken to be the string <code>'{c}_{v}'</code>. This specifies that the names of columns generated is the lowercase original column name followed by an underscore, followed by the lowercase value associated with the column. Any string can be used instead of formatspec (however, the string must be properly string-quoted). The string is taken literally, except for the fact that appearances of <code>'{c}'</code>, <code>'{v}'</code>, <code>'{C}'</code> and <code>'{V}'</code> in the original string are replaced by the lower-cased column name, the lower-cased column value, the original-case column name and the original-case column value, respectively. Alternatively, one can supply the name of a function instead of a string. This would cause this function to be called with two parameters (the column name and the column value). The function should return a text string, and that string will be used as the name of the generated column. </td></tr>
    <tr><td class="paramname">colchoice</td><td>A text parameter, allowing the caller explicit control over which columns are created in pivoting. The parameter's value is interpretted as string containing an (immutable) query that returns a table with a column called <code>"col_name"</code>. The values in this column will be the columns created. Prior to evaluating the string as a query, instances of <code>'{col}'</code> in it are replaced by the name of the column from which values are to be generated (<em>'t.fcolx'</em> if parameter <em>'fcolx'</em> is specified and non-NULL, <em>'t.colx'</em>, otherwise), and, similarly, instances of <code>'{tabl}'</code> are replaced by the value in parameter <em>'t'</em>. The default value for this parameter is <code>"SELECT DISTINCT {col} AS col_name FROM {tabl};"</code>. SUgAR provides several convenience functions (<code>"ALL_VALS"</code>, <code>"FREQ_VALS"</code> and <code>"ALL_BUT_ONE"</code>) which can be used as the <em>'colchoice'</em> parameter: use <code>'all_vals()'</code> to create all columns, as is the default behavior; use <code>'freq_vals(<em>n</em>)'</code>, for any <em>n</em> value, to create columns only for the top <em>n</em> most frequent values. Use <code>'all_but_one()'</code> to create all columns except an arbitrarily chosen one.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The function returns a set of aggregation results, of the type returned by <em>agg</em>. (This is not possible return type for a standard SQL row function.)</dd></dl>
<p><a class="anchor" id="pivot_usage"></a></p><dl class="section user"><dt>Usage</dt><dd>This SUgAR pseudo-aggregate-function is used to perform pivoting. It behaves as a list of aggregate functions, generating multiple columns. The values of <em>'colx'</em> (or <em>'fcolx'</em>, if it is supplied) determine a set of columns to be created. For each row, the value of <em>'colv'</em> is placed into the column associated with the currenct <em>'colx'</em> value. If this pseudo-aggregate is applied in a query that groups by a <em>'coly'</em> column, the cell in which <em>'colv'</em> values are placed is determined by this '<em>colx'+'<em>coly'</em> combination:</em> <em>'colx'</em> determines the choice of column; <em>'coly'</em> - the choice of row. If multiple <em>'colv'</em> values are mapped into a single cell, they are aggregated by a user-defined aggregate. The default aggregation method, however, is simply to report an error if such collisions exist.</dd></dl>
<p>Note that <code>'pivot'</code> acts as an aggregate function (or, rather, as a combination of aggregate functions). It should therefore only be applied in contexts that allow aggregation. If you are looking for a pivoting pseudofunction, rather than a pseudo-aggregate, consider <a class="el" href="group__grp__pivot01.html">pivot01 (Pseudofunction)</a>.</p>
<p><a class="anchor" id="pivot_example"></a></p><dl class="section user"><dt>Examples</dt><dd><pre class="fragment">user=# CREATE TABLE patient_table
user-# (patient_id INTEGER, name TEXT, from_date DATE, diagnosis_code TEXT)
user-# DISTRIBUTED BY (patient_id);
CREATE TABLE
user=# 
user=# INSERT INTO patient_table VALUES
user-# (1, 'John Smith', '2012/2/5', 'ICD9-CM-845.0'),
user-# (1, 'John Smith', '2001/12/23', 'ICD9-CM-785.2'),
user-# (2, 'Jane Smith', '2010/12/6', 'ICD9-CM-785.2'),
user-# (3, 'Ben Franklin', '1785/4/17', 'ICD9-CM-274.9'),
user-# (4, 'Hillary Clinton', '2012/1/1', 'ICD9-CM-434.0')
user-# ;
INSERT 0 5
user=#
user=# CREATE FUNCTION truncname(col TEXT, val TEXT)
user-# RETURNS TEXT
user-# IMMUTABLE
user-# LANGUAGE SQL
user-# AS $$
user$#   SELECT substring($2 FROM 9 FOR 5);
user$# $$;
CREATE FUNCTION
user=#
user=# SELECT sugar($$
user$#   CREATE TABLE outtable AS
user$#     SELECT patient_id AS id, name,
user$#            pivot(diagnosis_code, patient_table, from_date,
user$#                  unique_element, NULL, NULL, truncname)
user$#     FROM patient_table GROUP BY (id,name)
user$#   DISTRIBUTED BY (id);
user$# $$);
 sugar
-------

(1 row)

user=# SELECT * FROM outtable;
 id |      name       |   274.9    |   434.0    |   785.2    |   845.0    
----+-----------------+------------+------------+------------+------------
  2 | Jane Smith      |            |            | 2010-12-06 | 
  4 | Hillary Clinton |            | 2012-01-01 |            | 
  1 | John Smith      |            |            | 2001-12-23 | 2012-02-05
  3 | Ben Franklin    | 1785-04-17 |            |            | 
(4 rows)
</pre></dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="group__grp__pivot01.html" title="Make 0/1 columns (dummy variables) out of a categorical column. ">pivot01 (Pseudofunction)</a>, <a class="el" href="group__grp__all__vals.html">all_vals</a>, <a class="el" href="group__grp__freq__vals.html">freq_vals</a>, <a class="el" href="group__grp__all__but__one.html">all_but_one</a>, <a class="el" href="group__grp__choose__any.html">choose_any (Aggregate)</a>, <a class="el" href="group__grp__unique__element.html">unique_element (Aggregate)</a></dd></dl>
<p>(Written by <a href="#" onclick="location.href='mai'+'lto:'+'mbr'+'an'+'d@p'+'iv'+'ota'+'l.'+'io'; return false;">Michael Brand</a>, 3 Mar 2013.) </p>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.nl/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
