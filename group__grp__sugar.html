<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="pdltools_extra.css" rel="stylesheet" type="text/css"/>
<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-47128600-1', 'auto');
    ga('send', 'pageview');
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="pdl.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">PDL Tools
   &#160;<span id="projectnumber">1.8</span>
   </div>
   <div id="projectbrief">User Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="gettingstarted.html"><span>Getting&#160;Started</span></a></li>
      <li><a href="installpage.html"><span>Installation</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="changelog.html"><span>Change&#160;Log</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Groups</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">sugar<div class="ingroups"><a class="el" href="group__grp__sugar__framework.html">The SUgAR Framework</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><b>Contents</b> </p><ul>
<li class="level1">
<a href="#sugar_syntax">Syntax</a> </li>
<li class="level1">
<a href="#sugar_usage">Usage</a> </li>
<li class="level1">
<a href="#sugar_example">Example</a> </li>
</ul>
</div><dl class="section user"><dt>About</dt><dd><code>'sugar'</code> is the main function for the SUgAR library. It accepts a textual parameter, and this parameter is expected to be a SQL query, possibly including special add-ons that SUgAR enables.</dd></dl>
<p><a class="anchor" id="sugar_syntax"></a></p><dl class="section user"><dt>Syntax</dt><dd><pre class="syntax">
FUNCTION sugar(orig_query VARCHAR [, user_table VARCHAR]) RETURNS TEXT;
</pre></dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">orig_query</td><td>The SUgAR query to be executed. </td></tr>
    <tr><td class="paramname">user_table</td><td>Name of optional user table, to supplement the built-in SUgAR functions described in the table <code>sugar_db</code>. The table should follow the same format as <code>sugar_db</code>. The function acts as if the rows of <em>user_table</em> are appended into <code>sugar_db</code>.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>SUgAR's return value is a text parameter, usually the empty string but may include usage messages from SUgAR if the user asks for these.</dd></dl>
<p><a class="anchor" id="sugar_usage"></a></p><dl class="section user"><dt>Usage</dt><dd><code>'sugar'</code> is the main function for the SUgAR library. It accepts a textual parameter, and this parameter is expected to be a SQL query, which is subsequently executed in the database. Before executing it, however, SUgAR performs shallow parsing of the SQL code, extracts function calls to functions which it recognizes and replaces them by dynamically-generated code. This second-order parsing supplements the underlying SQL syntax, which, natively, does not have such parsing abilities. The result is a far more powerful syntax, able to easily support common analytics activities (such as pivoting) that are notoriously difficult to support with native SQL.</dd></dl>
<p>The functions that SUgAR recognizes, which we call 'SUgAR functions', are not part of the definition of the <code>'sugar'</code> function. Rather, they are defined inside the tables <code>sugar_db</code> and <code>sugar_help_db</code> (which can be supplemented by the additional <em>user_table</em> argument). This design makes SUgAR 100% extendable.</p>
<p>Because SUgAR's functions can do things that normal SQL functions cannot, they are not, technically, functions. We refer to them as 'pseudofunctions'. However, we do distinguish between SUgAR functions that can appear in places where one would normally expect a function, those that can appear where one would normally expect an aggregate and those that can appear where one would normally expect a window function. We refer to these as pseudofunctions, pseudo-aggregates and pseudo-window-functions, respectively. We note that GPDB does not currently support user-defined window functions, so SUgAR's pseudo-window-functions are the only way to define such UDWFs, even though this particular SUgAR feature does not require breaking the SQL standard.</p>
<dl class="section warning"><dt>Warning</dt><dd>Never add function definitions directly into <code>sugar_db</code> and <code>sugar_help_db</code>, as such additons will be overwritten and erased next time the library is upgraded. To extend SUgAR, always use the <code>'user_table'</code> functionality.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>A limitation when using SUgAR is that it cannot return tables. To use SUgAR effectively, the SQL query which is the parameter to the SUgAR function (we refer to it as the 'sugar-coated' query) should be a table creation query, rather than a <code>SELECT</code> query. Thus, in addition to the basic sugar-coating (enveloping your query inside a 'sugar(...)' string), usage of SUgAR typically involves the following idiom: <pre class="fragment">   DROP TABLE IF EXISTS outtable;
   SELECT sugar('CREATE TABLE outtable AS ...');
   SELECT * FROM outtable;
</pre></dd></dl>
<dl class="section user"><dt>Getting Help on SUgAR and the <code>'sugar'</code> function</dt><dd>All SQL functions in the SUgAR schema (except <code>'sugar_version()'</code>, aggregate functions and internal functions) can be called with no parameters or with the parameter '' for a brief usage message (unless this conflicts with their regular functionality), as well as with the single textual parameter <code>'usage'</code> for their full documentation. In particular, this is true for <code>'sugar'</code>, the main function of the SUgAR library.</dd></dl>
<p>The following are additional methods to get help regarding the SUgAR library, the <code>'sugar'</code> function and the SUgAR pseudofunctions.</p>
<pre class="example">
SELECT sugar();
SELECT sugar('');
</pre><p> A brief description of the <code>'sugar'</code> function, including how to get further help.</p>
<pre class="example">
SELECT sugar('about');
</pre><p> Overview of the SUgAR library.</p>
<pre class="example">
SELECT sugar('list' [, '<em>func_pattern'</em> [, '<em>user_table'</em>] ]);
</pre><p> Listing of the various SUgAR pseudofunctions supported, with a brief apropos-style description of each. (Note that this function lists only pseudofunctions, not regular SQL functions. So, for example, to get help on the SQL function <code>'proportional_trans'</code>, use <code>"SELECT proportional_trans('usage');"</code>, instead. All (non-aggregate) SQL functions in the SUgAR library provide help when invoked with either no parameters or with the single textual parameter <code>'usage'</code>.) The optional argument '<em>func_pattern'</em> is a pattern (possibly simply being the name of a pseudofunction). If given, the function only returns information about SUgAR pseudofunctions matching the pattern. The supported pattern format is the PostgreSQL <code>'LIKE'</code>. If omitted, <em>func_pattern</em> defaults to '' (all pseudofunctions). The optional parameter <em>user_table</em> is the name of a table with the same format as <em>sugar_help_db</em>. If used, rows in <em>user_table</em> are treated as though they have been appended to <em>sugar_help_db</em>.</p>
<pre class="example">
SELECT sugar('usage');
</pre><p> A full description of the <code>'sugar'</code> function, including usage examples.</p>
<pre class="example">
SELECT sugar('usage','<em>funcname'</em> [, '<em>user_table'</em>]);
</pre><p> Get usage help on any particular pseduofunction. (In this case: <em>funcname</em>.) Use <code>"SELECT sugar('usage','sugar_db');"</code> and <code>"SELECT sugar('usage','sugar_help_db');"</code> to get usage help regarding the two database tables used by SUgAR and how to use these in order to write your own SUgAR extensions. The optional parameter <em>user_table</em> is the name of a table with the same format as <em>sugar_help_db</em>. If used, rows in <em>user_table</em> are treated as though they have been appended to <em>sugar_help_db</em>.</p>
<pre class="example">
SELECT sugar_version();
</pre><p> Get the version-string describing the version number of the SUgAR library.</p>
<dl class="section user"><dt>AN IMPORTANT NOTE REGARDING SCHEMA QUALIFIERS</dt><dd>By default, all SUgAR's pseudofunctions, exactly like all other functions, must have full schema qualifications. So, for example, one would to use the SUgAR query</dd></dl>
<pre class="fragment">  CREATE TABLE outtable AS
    SELECT patient_id AS id, name,
      SUGAR_SCHEMA.pivot(diagnosis_code, patient_table, from_date,
        SUGAR_SCHEMA.unique_element)
    FROM patient_table GROUP BY (id,name)
  DISTRIBUTED BY (id);
</pre><p>rather than</p>
<pre class="fragment">  CREATE TABLE outtable AS
    SELECT patient_id AS id, name,
      pivot(diagnosis_code, patient_table, from_date,
        unique_element)
    FROM patient_table GROUP BY (id,name)
  DISTRIBUTED BY (id);
</pre><p>where <code>SUGAR_SCHEMA</code> is the schema housing the SUgAR library. This is consistent with the SQL method of keeping the namespace clean. However, it is possible to get SUgAR to recognize both the qualified and the unqualified pseudofunction names. The way to do so is to add <code>SUGAR_SCHEMA</code> to the search_path (again, consistent with standard SQL methods).</p>
<p>Because SUgAR's typing is not consistent with SQL typing, it was not possible for SUgAR's schema resolution to be exactly identical to SQL's. For example, if <code>SUGAR_SCHEMA</code> is on the search_path after another schema that also defines <code>'pivot'</code>, SUgAR would nevertheless treat <code>'pivot'</code> as the SUgAR pseudofunction, rather than the function appearing earlier on the path. The general rule is that SUgAR will only recognize the qualified names if <code>SUGAR_SCHEMA</code> is not on the path, but will recognize both versions of the names if it is on the path. The position of <code>SUGAR_SCHEMA</code> on the path does not change the treatment of pseudofunctions. For the purpose of pseudofunctions, <code>SUGAR_SCHEMA</code> is always treated as the first element on the path. (For regular functions appearing in <code>SUGAR_SCHEMA</code>, standard SQL rules apply, of course.)</p>
<p>Note that in either case, SUgAR's name resolution is case insensitive.</p>
<p><a class="anchor" id="sugar_example"></a></p><dl class="section user"><dt>Examples</dt><dd><pre class="fragment">user=# DROP TABLE IF EXISTS outtable;
DROP TABLE
user=#
user=# SELECT sugar($$
user$#   CREATE TABLE outtable AS
user$#     SELECT x,
user$#            zscore(x) AS col_zscore,
user$#            zscore(x,PARTITION BY x%3) AS win_zscore
user$#     FROM generate_series(1,10) x
user$#     DISTRIBUTED RANDOMLY;
user$# $$);
 sugar 
-------

(1 row)

user=# SELECT * FROM outtable ORDER BY x;
 x  |       col_zscore        |       win_zscore        
----+-------------------------+-------------------------
  1 |     -1.4863010829205868 |     -1.1618950038622251
  2 | -1.15601195338267862269 | -1.00000000000000000000
  3 | -0.82572282384477044478 | -1.00000000000000000000
  4 | -0.49543369430686226687 | -0.38729833462074168704
  5 | -0.16514456476895408896 |  0.00000000000000000000
  6 |  0.16514456476895408896 |  0.00000000000000000000
  7 |  0.49543369430686226687 |  0.38729833462074168704
  8 |  0.82572282384477044478 |  1.00000000000000000000
  9 |  1.15601195338267862269 |  1.00000000000000000000
 10 |      1.4863010829205868 |      1.1618950038622251
(10 rows)
</pre></dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="group__grp__sugar__db.html">sugar_db (Table)</a>, <a class="el" href="group__grp__sugar__help__db.html">sugar_help_db (Table)</a> </dd></dl>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.nl/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
